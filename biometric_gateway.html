<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRIVAS // ATOMIC</title>
    <style>
        body { 
            background-color: #000; color: #0f0; font-family: 'Courier New', monospace; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; margin: 0; overflow: hidden;
        }
        #camera-frame {
            width: 300px; height: 300px; border: 4px solid #333; border-radius: 50%; 
            overflow: hidden; position: relative; background: #111;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .btn { 
            margin-top: 20px; padding: 15px 30px; background: #004400; color: #0f0; 
            border: 1px solid #0f0; font-weight: bold; cursor: pointer; display: none;
        }

        #logs {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px; 
            background: #050505; border-top: 2px solid #0f0; padding: 10px; 
            overflow-y: scroll; font-size: 12px; z-index: 100;
        }
        
        /* If this shows, CSS is working */
        #heartbeat {
            width: 10px; height: 10px; background: red; position: fixed; top: 10px; right: 10px;
        }
    </style>
</head>
<body>

    <div id="heartbeat"></div>
    <h1>BRIVAS SYSTEM</h1>
    <h3 id="status">INITIALIZING...</h3>

    <div id="camera-frame">
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <button id="startBtn" class="btn">START AUTHENTICATION</button>

    <div id="logs">Waiting for JS...<br></div>

    <script>
        // 1. VISUAL CHECK - Turns Blue if JS starts
        document.getElementById('heartbeat').style.background = "blue";

        function log(msg) {
            const div = document.getElementById('logs');
            div.innerHTML += `> ${msg}<br>`;
            div.scrollTop = div.scrollHeight;
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                log(`Attempting download: ${src}`);
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = "anonymous";
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }

        async function main() {
            try {
                log("JS Heartbeat Active.");
                
                // 2. LOAD AI LIBRARY (Switching to UNPKG)
                log(" downloading AI Engine from UNPKG...");
                await loadScript("https://unpkg.com/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
                log("AI Engine Downloaded!");

                // 3. CHECK OBJECT
                if (typeof mediapipe === 'undefined') {
                    throw new Error("MediaPipe loaded but global object is missing.");
                }
                log("MediaPipe Object Found.");

                // 4. INIT AI
                log("Compiling WASM (CPU Mode)...");
                const vision = await mediapipe.tasks.vision.FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
                );
                
                const faceLandmarker = await mediapipe.tasks.vision.FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                        delegate: "CPU"
                    },
                    outputFaceBlendshapes: true,
                    runningMode: "VIDEO",
                    numFaces: 1
                });
                log("AI Compiled Successfully.");

                // 5. CAMERA
                log("Requesting Camera...");
                const video = document.getElementById('webcam');
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                video.addEventListener("loadeddata", () => {
                    log("Camera Active.");
                    document.getElementById('status').innerText = "SYSTEM ONLINE";
                    document.getElementById('status').style.color = "#0f0";
                    document.getElementById('startBtn').style.display = "block";
                    
                    // Simple Loop
                    let lastTime = -1;
                    function loop() {
                        if (video.currentTime !== lastTime) {
                            lastTime = video.currentTime;
                            const res = faceLandmarker.detectForVideo(video, performance.now());
                            if(res.faceBlendshapes.length > 0) {
                                const blink = res.faceBlendshapes[0].categories.find(c=>c.categoryName==='eyeBlinkLeft').score;
                                if(blink > 0.5) document.getElementById('status').innerText = "BLINK DETECTED!";
                                else document.getElementById('status').innerText = "Tracking Face...";
                            }
                        }
                        requestAnimationFrame(loop);
                    }
                    loop();
                });

            } catch (err) {
                log("CRITICAL FAILURE: " + err.message);
                document.getElementById('status').innerText = "ERROR";
                document.getElementById('status').style.color = "red";
                document.getElementById('heartbeat').style.background = "red";
            }
        }

        main();
    </script>
</body>
</html>

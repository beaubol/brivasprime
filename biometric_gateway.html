<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRIVAS // LEGACY CORE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. LOAD LEGACY ENGINE (Robust & Compatible) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        /* --- CYBER VISUALS --- */
        body { background-color: #000510; color: #00f3ff; font-family: 'Courier New', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .eye-frame {
            position: relative; width: 300px; height: 300px; border-radius: 50%; 
            border: 2px solid #1e293b; background: #000; 
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1); overflow: hidden; transition: all 0.5s;
        }
        .active { border-color: #00f3ff; box-shadow: 0 0 60px rgba(0, 243, 255, 0.4); }
        .success { border-color: #10b981; box-shadow: 0 0 60px rgba(16, 185, 129, 0.6); }

        video {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); 
            opacity: 0.5; filter: grayscale(100%) contrast(1.2); transition: all 0.5s;
        }
        .active video { opacity: 1; filter: grayscale(0%); }

        .scanner {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: #00f3ff; box-shadow: 0 0 20px #00f3ff; opacity: 0; z-index: 10;
        }
        .active .scanner { opacity: 1; animation: scan 1.5s ease-in-out infinite; }
        @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

        .btn-cyber {
            background: rgba(0, 243, 255, 0.1); border: 1px solid #00f3ff; color: #00f3ff;
            padding: 15px 40px; font-weight: bold; letter-spacing: 3px; cursor: pointer;
            margin-top: 30px; transition: all 0.3s; display: none;
        }
        .btn-cyber:hover { background: #00f3ff; color: #000; box-shadow: 0 0 40px #00f3ff; }

        #terminal {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 120px;
            background: #001100; color: #0f0; font-size: 11px; padding: 15px;
            border-top: 1px solid #0f0; overflow-y: scroll;
        }
    </style>
</head>
<body>

    <!-- HUD -->
    <div class="absolute top-12 text-center z-20">
        <h1 class="text-5xl font-bold tracking-[0.2em] text-cyan-400 drop-shadow-lg">BRIVAS</h1>
        <div class="text-xs text-cyan-800 font-bold tracking-widest mt-2">LEGACY NEURAL CORE v1.0</div>
    </div>

    <!-- EYE -->
    <div class="relative z-10">
        <div id="eye" class="eye-frame">
            <video id="webcam" playsinline muted></video>
            <div class="scanner"></div>
        </div>
        <!-- Success Icon -->
        <div id="success-overlay" class="absolute inset-0 flex items-center justify-center hidden pointer-events-none">
            <div class="bg-emerald-500 p-6 rounded-full shadow-[0_0_50px_#10b981] animate-bounce">
                <svg class="w-12 h-12 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
            </div>
        </div>
    </div>

    <!-- CONTROLS -->
    <button id="startBtn" class="btn-cyber" onclick="startSystem()">INITIALIZE SYSTEM</button>
    
    <div id="challengeUI" class="hidden mt-8 text-center">
        <div id="icon" class="text-7xl mb-2 animate-bounce"></div>
        <div id="instruction" class="text-2xl font-bold tracking-widest text-cyan-300 animate-pulse"></div>
    </div>

    <div id="terminal">System Standby...</div>

    <script>
        function log(msg) {
            const t = document.getElementById('terminal');
            t.innerHTML += `> ${msg}<br>`;
            t.scrollTop = t.scrollHeight;
        }

        const video = document.getElementById('webcam');
        const eye = document.getElementById('eye');
        const btn = document.getElementById('startBtn');
        const ui = document.getElementById('challengeUI');
        const text = document.getElementById('instruction');
        const icon = document.getElementById('icon');
        
        let faceMesh;
        let camera;
        let currentChallenge = null;

        const CHALLENGES = [
            { id: 'blink', text: 'BLINK EYES', icon: 'ðŸ‘ï¸' },
            { id: 'smile', text: 'SMILE WIDE', icon: 'ðŸ˜ƒ' },
            { id: 'left', text: 'TURN LEFT', icon: 'â¬…ï¸' },
            { id: 'right', text: 'TURN RIGHT', icon: 'âž¡ï¸' }
        ];

        // 1. CHECK IF LIBRARY LOADED
        window.onload = function() {
            if (window.FaceMesh) {
                log("Legacy FaceMesh Loaded.");
                btn.style.display = "inline-block";
            } else {
                log("FATAL: CDN Blocked. Engine not found.");
            }
        };

        async function startSystem() {
            btn.style.display = 'none';
            log("Initializing Core...");

            try {
                faceMesh = new FaceMesh({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }});

                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults(onResults);
                log("Neural Net Built.");

                camera = new Camera(video, {
                    onFrame: async () => {
                        await faceMesh.send({image: video});
                    },
                    width: 640,
                    height: 480
                });

                log("Starting Optical Sensor...");
                await camera.start();
                
                log("SYSTEM ONLINE.");
                eye.classList.add('active');
                ui.classList.remove('hidden');
                nextChallenge();

            } catch (err) {
                log("CRITICAL ERROR: " + err.message);
                alert("Error: " + err.message);
            }
        }

        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && currentChallenge) {
                const landmarks = results.multiFaceLandmarks[0];
                checkLogic(landmarks);
            }
        }

        function checkLogic(landmarks) {
            // Simple Logic for Legacy Landmarks
            // Blink: Distance between eyelids
            // Smile: Distance between lip corners
            
            // 1. BLINK (Left Eye)
            const leftEyeTop = landmarks[159];
            const leftEyeBottom = landmarks[145];
            const eyeDist = Math.abs(leftEyeTop.y - leftEyeBottom.y);
            
            // 2. SMILE (Mouth Corners)
            const mouthLeft = landmarks[61];
            const mouthRight = landmarks[291];
            const mouthWidth = Math.abs(mouthLeft.x - mouthRight.x);

            // 3. TURN (Nose Position relative to eyes)
            const nose = landmarks[1];
            const leftCheek = landmarks[234];
            const rightCheek = landmarks[454];
            const faceCenter = (leftCheek.x + rightCheek.x) / 2;
            const turnVal = nose.x - faceCenter;

            let pass = false;

            if (currentChallenge.id === 'blink' && eyeDist < 0.009) pass = true;
            if (currentChallenge.id === 'smile' && mouthWidth > 0.25) pass = true;
            if (currentChallenge.id === 'left' && turnVal < -0.05) pass = true; // Inverted because mirror
            if (currentChallenge.id === 'right' && turnVal > 0.05) pass = true;

            if (pass) success();
        }

        function nextChallenge() {
            currentChallenge = CHALLENGES[Math.floor(Math.random() * CHALLENGES.length)];
            text.innerText = currentChallenge.text;
            icon.innerText = currentChallenge.icon;
            log("Task: " + currentChallenge.text);
        }

        function success() {
            currentChallenge = null;
            log("Verified.");
            eye.classList.remove('active');
            eye.classList.add('success');
            ui.classList.add('hidden');
            document.getElementById('success-overlay').classList.remove('hidden');
            
            setTimeout(() => {
                eye.classList.remove('success');
                eye.classList.add('active');
                document.getElementById('success-overlay').classList.add('hidden');
                ui.classList.remove('hidden');
                nextChallenge();
            }, 2000);
        }
    </script>
</body>
</html>

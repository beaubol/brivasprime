<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRIVAS // SECURE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Courier New', Courier, monospace; overflow: hidden; }
        
        /* EYE CONTAINER */
        .eye-frame {
            position: relative; width: 280px; height: 280px; margin: 0 auto;
            border-radius: 50%; border: 2px solid #333; background: #000;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1); overflow: hidden;
            transition: all 0.5s;
        }
        .eye-frame.active { border-color: #06b6d4; box-shadow: 0 0 40px #06b6d4; }
        .eye-frame.success { border-color: #10b981; box-shadow: 0 0 50px #10b981; }

        /* VIDEO */
        video {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(-1); opacity: 0.4; filter: grayscale(100%) contrast(1.2);
            transition: all 0.5s;
        }
        .eye-frame.active video { opacity: 1; filter: grayscale(0%); }

        /* SCANNER LASER */
        .scanner {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: #06b6d4; box-shadow: 0 0 15px #06b6d4; opacity: 0; z-index: 10;
        }
        .eye-frame.active .scanner { opacity: 1; animation: scan 1.5s ease-in-out infinite; }
        @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

        /* LOGS */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.8); color: #0f0; font-size: 10px;
            padding: 10px; overflow-y: scroll; z-index: 999; border-top: 1px solid #0f0;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen">

    <!-- HEADER -->
    <div class="absolute top-12 text-center z-20">
        <h1 class="text-4xl font-bold tracking-[0.3em] text-cyan-500" style="text-shadow: 0 0 10px rgba(6,182,212,0.8);">BRIVAS</h1>
        <div class="text-[10px] text-cyan-800 font-bold tracking-widest mt-2">SECURE BIOMETRIC GATEWAY</div>
    </div>

    <!-- VISUAL INTERFACE -->
    <div class="relative z-10 mt-10">
        <div id="eye" class="eye-frame">
            <video id="webcam" autoplay playsinline muted></video>
            <div class="scanner"></div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="mt-12 text-center z-20">
        <button id="startBtn" onclick="startSystem()" class="bg-slate-900 border border-cyan-500 text-cyan-500 px-8 py-3 font-bold tracking-widest hover:bg-cyan-500 hover:text-black transition-all">
            INITIALIZE
        </button>
        
        <div id="challengeBox" class="hidden mt-4">
            <div id="icon" class="text-6xl mb-2"></div>
            <div id="instruction" class="text-xl font-bold text-cyan-400 tracking-widest"></div>
        </div>
    </div>

    <!-- DEBUG CONSOLE (Always Visible) -->
    <div id="debug-console">System Standby...<br></div>

    <!-- 1. GLOBAL LOGGER (Safe Script) -->
    <script>
        function log(msg) {
            const c = document.getElementById('debug-console');
            c.innerHTML += `> ${msg}<br>`;
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }
        window.onerror = function(msg) { log("CRITICAL JS ERROR: " + msg); };
        log("UI Loaded. Waiting for user...");
    </script>

    <!-- 2. LOAD MEDIAPIPE (Global Bundle) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js" crossorigin="anonymous" onload="log('AI Library Downloaded.')" onerror="log('FAILED TO DOWNLOAD AI LIBRARY.')"></script>

    <!-- 3. MAIN LOGIC (Standard Script) -->
    <script>
        const video = document.getElementById('webcam');
        const eye = document.getElementById('eye');
        const startBtn = document.getElementById('startBtn');
        const challengeBox = document.getElementById('challengeBox');
        const instruction = document.getElementById('instruction');
        const icon = document.getElementById('icon');

        let faceLandmarker;
        let lastVideoTime = -1;
        let currentChallenge = null;

        const CHALLENGES = [
            { id: 'blink', text: 'BLINK EYES', icon: 'ðŸ‘ï¸', check: (s) => (s.eyeBlinkLeft > 0.5) },
            { id: 'smile', text: 'SMILE WIDE', icon: 'ðŸ˜ƒ', check

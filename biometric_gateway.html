<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioGuard Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MediaPipe Vision (Global Bundle) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    
    <style>
        body { background-color: #020617; color: white; font-family: sans-serif; overflow: hidden; }
        .camera-container { position: relative; width: 280px; height: 280px; margin: 0 auto; }
        .camera-ring {
            position: absolute; inset: 0; border-radius: 50%; 
            border: 4px solid #334155; overflow: hidden; 
            transition: all 0.3s ease;
        }
        .camera-ring.active { border-color: #3B82F6; box-shadow: 0 0 25px #3B82F6; }
        .camera-ring.success { border-color: #10B981; box-shadow: 0 0 25px #10B981; }
        
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #3B82F6;
            box-shadow: 0 0 15px #3B82F6; top: 0; animation: scan 2s linear infinite;
            display: none;
        }
        .active .scan-line { display: block; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        #success-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        #success-overlay.visible { opacity: 1; }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen">

    <!-- Header -->
    <div class="absolute top-8 text-center">
        <h1 class="text-blue-400 font-bold tracking-[0.2em] text-sm uppercase">BioGuard Secure</h1>
        <div class="text-xs text-slate-500 mt-1">v3.0 PureJS</div>
    </div>

    <!-- Camera UI -->
    <div class="camera-container">
        <div id="ring" class="camera-ring">
            <video id="webcam" autoplay playsinline muted></video>
            <div class="scan-line"></div>
            <div id="success-overlay">
                <div class="bg-emerald-500 p-4 rounded-full">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="mt-8 text-center min-h-[100px]">
        <button id="startBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-semibold shadow-lg shadow-blue-500/30 transition-transform active:scale-95">
            Initialize Gateway
        </button>

        <div id="challengeUI" class="hidden animate-bounce">
            <div id="icon" class="text-5xl mb-2"></div>
            <h2 id="instruction" class="text-2xl font-bold"></h2>
        </div>
        
        <div id="statusUI" class="hidden text-emerald-400 font-bold text-xl mt-4">
            IDENTITY VERIFIED
        </div>
    </div>

    <!-- Footer Status -->
    <div class="absolute bottom-6 bg-white/5 px-4 py-1 rounded-full border border-white/10">
        <span id="statusDot" class="inline-block w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></span>
        <span id="statusText" class="text-xs font-mono text-slate-400">Loading Engine...</span>
    </div>

    <script>
        // --- CORE LOGIC ---
        const video = document.getElementById('webcam');
        const startBtn = document.getElementById('startBtn');
        const ring = document.getElementById('ring');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');
        
        let faceLandmarker;
        let currentChallenge = null;
        let runningMode = "VIDEO";
        let lastVideoTime = -1;

        const CHALLENGES = [
            { id: 'blink', label: 'Blink Eyes', icon: 'ðŸ˜‰', score: 'eyeBlinkLeft', val: 0.5 },
            { id: 'smile', label: 'Smile Wide', icon: 'ðŸ˜ƒ', score: 'mouthSmileLeft', val: 0.5 },
            { id: 'turnLeft', label: 'Turn Left', icon: 'â¬…ï¸', score: 'eyeLookOutLeft', val: 0.5 },
            { id: 'mouth', label: 'Open Mouth', icon: 'ðŸ˜®', score: 'jawOpen', val: 0.3 }
        ];

        // 1. Load AI Engine
        async function init() {
            try {
                const vision = await mediapipe.tasks.vision.FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );
                faceLandmarker = await mediapipe.tasks.vision.FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                        delegate: "GPU"
                    },
                    outputFaceBlendshapes: true,
                    runningMode: runningMode,
                    numFaces: 1
                });
                
                statusText.innerText = "System Ready";
                statusDot.classList.replace('bg-yellow-500', 'bg-blue-500');
                
                // Start Camera immediately
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predict);
                
            } catch (err) {
                statusText.innerText = "Error: " + err.message;
                statusDot.classList.replace('bg-yellow-500', 'bg-red-500');
            }
        }

        // 2. Prediction Loop
        async function predict() {
            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                if (faceLandmarker) {
                    const startTimeMs = performance.now();
                    const results = faceLandmarker.detectForVideo(video, startTimeMs);
                    
                    if (results.faceBlendshapes && results.faceBlendshapes.length > 0 && currentChallenge) {
                        checkProgress(results.faceBlendshapes[0].categories);
                    }
                }
            }
            requestAnimationFrame(predict);
        }

        // 3. Game Logic
        function checkProgress(blendshapes) {
            const metric = blendshapes.find(c => c.categoryName === currentChallenge.score);
            if (metric && metric.score > currentChallenge.val) {
                completeChallenge();
            }
        }

        startBtn.addEventListener('click', () => {
            startBtn.classList.add('hidden');
            document.getElementById('challengeUI').classList.remove('hidden');
            ring.classList.add('active');
            statusText.innerText = "Authenticating...";
            
            // Pick random challenge
            currentChallenge = CHALLENGES[Math.floor(Math.random() * CHALLENGES.length)];
            document.getElementById('icon').innerText = currentChallenge.icon;
            document.getElementById('instruction').innerText = currentChallenge.label;
        });

        function completeChallenge() {
            currentChallenge = null; // Stop checking
            document.getElementById('challengeUI').classList.add('hidden');
            ring.classList.remove('active');
            ring.classList.add('success');
            document.getElementById('success-overlay').classList.add('visible');
            document.getElementById('statusUI').classList.remove('hidden');
            statusText.innerText = "Verified";
            statusDot.classList.replace('bg-blue-500', 'bg-emerald-500');
            statusDot.classList.remove('animate-pulse');
        }

        // Auto-start
        init();
    </script>
</body>
</html>
